<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CineView Admin Pro | Abyss Folder Explorer</title>
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0b0f1a; color: #e2e8f0; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .custom-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        input, select, textarea { background: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; }
        .folder-card { border-left: 4px solid #facc15; background: rgba(250, 204, 21, 0.1) !important; }
        .file-card { border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.1) !important; }
        .card-active:active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body class="p-4 md:p-10 font-sans">

<div class="max-w-5xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-indigo-500 tracking-tighter">CINEVIEW PRO</h1>
            <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Abyss Folder-to-Episode Automator</p>
        </div>
        <div id="syncStatus" class="hidden flex items-center gap-2 bg-blue-500/10 text-blue-400 border border-blue-500/20 px-4 py-2 rounded-full text-[10px] font-bold uppercase animate-pulse">
            <span class="w-2 h-2 bg-blue-500 rounded-full"></span> GitHub Uploading...
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column -->
        <div class="space-y-6">
            <!-- Search & Type -->
            <div class="glass-card rounded-3xl p-6 space-y-4">
                <div class="flex gap-2">
                    <select id="contentType" onchange="toggleType()" class="w-32 p-3 rounded-xl text-xs font-bold outline-none cursor-pointer">
                        <option value="movie">Movie</option>
                        <option value="series">Series</option>
                    </select>
                    <input type="text" id="apiSearch" oninput="searchTMDB()" placeholder="Search TMDB..." class="flex-grow p-3 rounded-xl text-sm outline-none">
                </div>
                <div id="tmdbResults" class="flex gap-3 overflow-x-auto pb-4 custom-scroll min-h-[160px]">
                    <p class="text-slate-600 text-xs italic py-10 w-full text-center">Search for content on TMDB...</p>
                </div>
                <div id="seasonWrapper" class="hidden bg-indigo-500/10 p-4 rounded-2xl border border-indigo-500/20">
                    <label class="text-[10px] font-bold text-indigo-400 uppercase mb-2 block">Select Season</label>
                    <select id="seasonPicker" onchange="applySeason(this.value)" class="w-full p-3 rounded-xl text-xs outline-none"></select>
                </div>
            </div>

            <!-- Abyss Explorer -->
            <div class="glass-card rounded-3xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Abyss Library</h3>
                        <button id="abyssBack" onclick="fetchAbyss()" class="hidden bg-yellow-600 hover:bg-yellow-500 text-white text-[9px] font-black px-3 py-1 rounded-full transition-all">
                            ‚Üê BACK TO ROOT
                        </button>
                    </div>
                    <button onclick="fetchAbyss(currentFolderId)" class="text-[10px] text-blue-500 font-bold uppercase hover:underline">Refresh</button>
                </div>
                <div id="abyssList" class="flex gap-3 overflow-x-auto pb-4 custom-scroll min-h-[120px]">
                    <!-- Items Load Here -->
                </div>
                <div class="flex justify-between items-center mt-2">
                    <p id="abyssPathDisplay" class="text-[9px] text-slate-500 italic">Location: Root</p>
                    <div class="flex gap-2">
                        <span class="flex items-center gap-1 text-[8px] uppercase font-bold text-yellow-500">‚óè Folder</span>
                        <span class="flex items-center gap-1 text-[8px] uppercase font-bold text-blue-500">‚óè File</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="glass-card rounded-3xl p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Title</label>
                    <input type="text" id="mName" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Slug / ID</label>
                    <input type="text" id="mId" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
            </div>

            <div id="movieBox">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Embed Source (short.icu)</label>
                <input type="text" id="mSrc" placeholder="https://short.icu/..." oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
            </div>

            <div id="seriesBox" class="hidden">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Episode List</label>
                    <button onclick="document.getElementById('mEpisodes').value = ''; updateOutputs();" class="text-[9px] text-red-500 font-bold hover:underline">CLEAR ALL</button>
                </div>
                <textarea id="mEpisodes" rows="6" oninput="updateOutputs()" placeholder="Files clicked in Abyss will appear here..." class="w-full p-3 rounded-xl text-xs outline-none font-mono leading-relaxed"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Poster URL</label>
                    <input type="text" id="mImg" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Year</label>
                    <input type="text" id="mYear" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
            </div>
            
            <input type="hidden" id="mTmdb">

            <button id="syncBtn" onclick="triggerGHSync()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-900/30 transition-all uppercase tracking-widest text-sm">
                üöÄ Auto-Sync to GitHub
            </button>
            <button onclick="triggerTelegram()" class="w-full border border-slate-800 text-slate-500 py-3 rounded-2xl text-[10px] font-bold uppercase tracking-widest hover:bg-slate-800 transition">
                Notify Telegram
            </button>
        </div>
    </div>

    <!-- Codes -->
    <div class="glass-card rounded-3xl p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block tracking-widest">JavaScript Data</label>
            <textarea id="outJS" rows="6" readonly class="w-full p-4 rounded-2xl text-[10px] font-mono text-blue-400 outline-none" onclick="this.select()"></textarea>
        </div>
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block tracking-widest">HTML Item</label>
            <textarea id="outHTML" rows="6" readonly class="w-full p-4 rounded-2xl text-[10px] font-mono text-indigo-400 outline-none" onclick="this.select()"></textarea>
        </div>
    </div>
</div>

<script>
const TMDB_API = 'dc691868b09daaabe9acc238ed898cf7';
const ABYSS_API = '391ea7f7e967589e017d3b3924b1c33f';
const TG_TOKEN = '7287243554:AAHa43wD_V2roGLep1aQgKHn0vqXHYlFp-M';
const TG_CHAT = '-1003605866054';
const IMG_BASE = 'https://image.tmdb.org/t/p/w500';

let currentSeasons = [];
let selectedMovie = null;
let currentFolderId = null;

window.onload = () => fetchAbyss();

function toggleType() {
    const isSeries = document.getElementById('contentType').value === 'series';
    document.getElementById('movieBox').classList.toggle('hidden', isSeries);
    document.getElementById('seriesBox').classList.toggle('hidden', !isSeries);
    document.getElementById('seasonWrapper').classList.add('hidden');
    updateOutputs();
}

// --- Robust Abyss Explorer ---
async function fetchAbyss(folderId = null) {
    currentFolderId = folderId;
    const list = document.getElementById('abyssList');
    const backBtn = document.getElementById('abyssBack');
    const pathLabel = document.getElementById('abyssPathDisplay');
    
    list.innerHTML = '<div class="w-full py-10 text-center text-blue-500 text-[10px] font-bold animate-pulse">SYNCHRONIZING...</div>';
    folderId ? backBtn.classList.remove('hidden') : backBtn.classList.add('hidden');
    pathLabel.innerText = folderId ? `Location: Subfolder (${folderId})` : "Location: Root";

    try {
        let url = `https://api.abyss.to/v1/resources?key=${ABYSS_API}&maxResults=100`;
        if (folderId) url += `&folderId=${folderId}`;
        
        const res = await puter.net.fetch(url);
        const data = await res.json();
        list.innerHTML = '';

        if (!data.items || data.items.length === 0) {
            list.innerHTML = '<div class="w-full py-10 text-center text-slate-600 text-[10px]">Folder is empty.</div>';
            return;
        }

        data.items.forEach(item => {
            // Check type explicitly. Some APIs use 'folder'/'file', others use 'folders'/'files'
            const isFolder = item.type === 'folder' || item.type === 'folders' || item.is_folder === true;
            
            const div = document.createElement('div');
            div.className = `flex-shrink-0 w-36 glass-card p-3 rounded-2xl cursor-pointer hover:border-white transition-all card-active ${isFolder ? 'folder-card' : 'file-card'}`;
            
            div.onclick = (e) => {
                e.preventDefault();
                if (isFolder) {
                    // It is a folder: Navigate into it
                    console.log("Navigating into folder:", item.id);
                    fetchAbyss(item.id);
                } else {
                    // It is a file: Add link to the input fields
                    const link = `https://short.icu/${item.id}`;
                    const isSeries = document.getElementById('contentType').value === 'series';
                    
                    if (isSeries) {
                        const epArea = document.getElementById('mEpisodes');
                        const currentVal = epArea.value.trim();
                        epArea.value = currentVal ? (currentVal + '\n' + link) : link;
                    } else {
                        document.getElementById('mSrc').value = link;
                    }
                    updateOutputs();
                }
            };

            div.innerHTML = `
                <div class="text-[16px] mb-1">${isFolder ? 'üìÅ' : 'üìÑ'}</div>
                <div class="text-[10px] font-bold truncate">${item.name}</div>
                <div class="text-[8px] text-slate-500 mt-1 uppercase font-black">
                    ${isFolder ? '<span class="text-yellow-500">OPEN FOLDER</span>' : '<span class="text-blue-500">ADD EPISODE</span>'}
                </div>
            `;
            list.appendChild(div);
        });
    } catch (e) { 
        list.innerHTML = '<div class="w-full py-10 text-center text-red-500 text-[10px]">Connection Error.</div>'; 
    }
}

// --- TMDB Integration ---
async function searchTMDB() {
    const query = document.getElementById('apiSearch').value.trim();
    const type = document.getElementById('contentType').value === 'series' ? 'tv' : 'movie';
    const resDiv = document.getElementById('tmdbResults');
    if (query.length < 2) return;

    try {
        const res = await fetch(`https://api.themoviedb.org/3/search/${type}?api_key=${TMDB_API}&query=${encodeURIComponent(query)}`);
        const data = await res.json();
        resDiv.innerHTML = '';
        data.results.slice(0, 10).forEach(item => {
            const card = document.createElement('div');
            card.className = 'flex-shrink-0 w-24 text-center space-y-2 cursor-pointer group';
            const poster = item.poster_path ? IMG_BASE + item.poster_path : 'https://via.placeholder.com/200x300';
            const year = (item.release_date || item.first_air_date || 'N/A').split('-')[0];
            card.onclick = () => selectMovie(item, poster, year);
            card.innerHTML = `
                <img src="${poster}" class="w-full h-36 object-cover rounded-xl border border-slate-800 group-hover:border-blue-500 transition-all shadow-lg">
                <p class="text-[9px] font-bold truncate uppercase tracking-tighter">${item.title || item.name}</p>
            `;
            resDiv.appendChild(card);
        });
    } catch (e) {}
}

async function selectMovie(item, poster, year) {
    selectedMovie = item;
    const title = item.title || item.name;
    document.getElementById('mName').value = title;
    document.getElementById('mImg').value = poster;
    document.getElementById('mYear').value = year;
    document.getElementById('mTmdb').value = item.id;
    document.getElementById('mId').value = title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');

    if (document.getElementById('contentType').value === 'series') {
        const res = await fetch(`https://api.themoviedb.org/3/tv/${item.id}?api_key=${TMDB_API}`);
        const data = await res.json();
        currentSeasons = data.seasons;
        const picker = document.getElementById('seasonPicker');
        picker.innerHTML = '<option value="">-- Choose Season --</option>';
        currentSeasons.forEach(s => {
            if (s.season_number === 0) return;
            picker.innerHTML += `<option value="${s.season_number}">${s.name} (${s.episode_count} Eps)</option>`;
        });
        document.getElementById('seasonWrapper').classList.remove('hidden');
    }
    updateOutputs();
}

function applySeason(num) {
    if(!num) return;
    const s = currentSeasons.find(i => i.season_number == num);
    document.getElementById('mName').value = `${selectedMovie.name} - Season ${num}`;
    document.getElementById('mId').value = `${selectedMovie.name.toLowerCase().replace(/[^a-z0-9]/g, '-')}-s${num}`;
    if(s.poster_path) document.getElementById('mImg').value = IMG_BASE + s.poster_path;
    updateOutputs();
}

function updateOutputs() {
    const type = document.getElementById('contentType').value;
    const name = document.getElementById('mName').value;
    const id = document.getElementById('mId').value;
    const img = document.getElementById('mImg').value;
    const year = document.getElementById('mYear').value;
    const tmdb = document.getElementById('mTmdb').value;

    let movieObj = { title: name, img: img, year: year, tmdb: tmdb, type: type };
    if (type === 'series') {
        movieObj.episodes = document.getElementById('mEpisodes').value.split('\n').filter(l => l.trim() !== "");
    } else {
        movieObj.src = document.getElementById('mSrc').value;
    }

    document.getElementById('outJS').value = `"${id}": ${JSON.stringify(movieObj, null, 2)},`;
    document.getElementById('outHTML').value = `<a href="newplayer/player?id=${id}&tmdb=${tmdb}" class="movie-link" data-id="${tmdb}">
    <div class="movie-card">
        <div class="movie-poster-container"><img src="${img}" class="movie-poster"></div>
        <div class="movie-info">
            <h3>${name}</h3>
            <p>${year} | ${type === 'movie' ? 'Movie' : 'Web Series'}</p>
        </div>
    </div>
</a>`;
}

// --- GitHub Sync ---
async function triggerGHSync() {
    const token = localStorage.getItem('ghToken');
    const user = localStorage.getItem('ghUser');
    const repo = localStorage.getItem('ghRepo');
    const path = localStorage.getItem('ghPath');

    if (!token || !selectedMovie) return alert("Config missing in LocalStorage!");

    const btn = document.getElementById('syncBtn');
    btn.disabled = true;
    btn.innerText = "PUSHING...";

    try {
        const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
        const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
        const data = await res.json();
        
        let content = atob(data.content);
        const newEntry = document.getElementById('outJS').value;
        const lastBrace = content.lastIndexOf('}');
        const updatedContent = content.slice(0, lastBrace) + `  ${newEntry}\n` + content.slice(lastBrace);

        const push = await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: `Update: ${document.getElementById('mName').value}`,
                content: btoa(unescape(encodeURIComponent(updatedContent))),
                sha: data.sha
            })
        });

        if (push.ok) alert("üéâ Website Updated!");
        else alert("Push Failed.");
    } catch (e) { alert("Error: " + e.message); }
    
    btn.disabled = false;
    btn.innerText = "üöÄ Auto-Sync to GitHub";
}

async function triggerTelegram() {
    const name = document.getElementById('mName').value;
    const img = document.getElementById('mImg').value;
    const id = document.getElementById('mId').value;
    const msg = `üé¨ *NEW ON CINEVIEW* \n\nüçø *${name}*\n\nüîó [WATCH NOW](https://prigames.netlify.app/movies/newplayer/player?id=${id})`;

    try {
        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendPhoto`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: TG_CHAT, photo: img, caption: msg, parse_mode: 'Markdown' })
        });
        alert("Telegram Notification Sent!");
    } catch (e) { alert("Telegram Failed."); }
}
</script>
</body>
</html>

