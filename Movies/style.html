<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineView Admin Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; padding: 20px; }
        .container { max-width: 900px; margin: auto; display: flex; flex-direction: column; gap: 20px; }
        .admin-section { background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: white; box-sizing: border-box; }
        .flex-row { display: flex; gap: 15px; }
        .flex-item { flex: 1; }

        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 15px; }
        .tmdb-card { background: #262626; padding: 8px; cursor: pointer; text-align: center; border-radius: 8px; transition: 0.2s; border: 1px solid transparent; }
        .tmdb-card:hover { border-color: #0088cc; }
        .tmdb-card img { width: 100%; border-radius: 5px; height: 170px; object-fit: cover; }
        .tmdb-card p { font-size: 11px; margin: 5px 0; height: 30px; overflow: hidden; }

        .btn-send { background: #0088cc; color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        label { font-weight: bold; font-size: 12px; color: #888; text-transform: uppercase; }
        .hidden { display: none; }
        h2 { color: #0088cc; margin-top: 0; }
    </style>
</head>
<body>

<div class="container">
    <h2>CineView Admin Panel</h2>

    <div class="admin-section">
        <div class="flex-row">
            <div style="width: 150px;">
                <label>Type</label>
                <select id="contentType" onchange="toggleType()">
                    <option value="movie">Movie</option>
                    <option value="series">Series (Episodes)</option>
                </select>
            </div>
            <div class="flex-item">
                <label>Search TMDB (Name or ID)</label>
                <input type="text" id="apiSearch" oninput="searchTMDB()" placeholder="Search title or enter TMDB ID...">
            </div>
        </div>
        <div id="results" class="results-grid"></div>
    </div>

    <div class="admin-section">
        <label>Title</label>
        <input type="text" id="mName" oninput="updateOutputs()">

        <label>Custom ID (Slug)</label>
        <input type="text" id="mId" oninput="updateOutputs()">

        <div id="movieLinkBox">
            <label>Video Source Link (Single Movie)</label>
            <input type="text" id="mSrc" placeholder="https://..." oninput="updateOutputs()">
        </div>

        <div id="seriesLinkBox" class="hidden">
            <label>Episode Links (One URL per line)</label>
            <textarea id="mEpisodes" rows="5" placeholder="https://link1.com&#10;https://link2.com" oninput="updateOutputs()"></textarea>
        </div>

        <div class="flex-row">
            <div class="flex-item">
                <label>Poster URL</label>
                <input type="text" id="mImg" oninput="updateOutputs()">
            </div>
            <div class="flex-item">
                <label>Year / Metadata</label>
                <input type="text" id="mYear" oninput="updateOutputs()">
            </div>
        </div>
        
        <input type="hidden" id="mTmdb">
        <button class="btn-send" onclick="triggerTelegram()">üöÄ Post to Telegram</button>
    </div>

    <div class="admin-section">
        <label>JS Config Object</label>
        <textarea id="outJS" rows="5" readonly onclick="this.select()"></textarea>
        
        <label>HTML List Item</label>
        <textarea id="outHTML" rows="4" readonly onclick="this.select()"></textarea>
    </div>
</div>

<script>
const API_KEY = 'dc691868b09daaabe9acc238ed898cf7';
const IMG_PATH = 'https://image.tmdb.org/t/p/w500';
const TELEGRAM_TOKEN = '7287243554:AAHa43wD_V2roGLep1aQgKHn0vqXHYlFp-M';
const TELEGRAM_CHAT_ID = '-1003605866054';

let selectedMovieData = null;

function toggleType() {
    const type = document.getElementById('contentType').value;
    document.getElementById('movieLinkBox').className = (type === 'movie') ? '' : 'hidden';
    document.getElementById('seriesLinkBox').className = (type === 'series') ? '' : 'hidden';
    updateOutputs();
}

async function searchTMDB() {
    const query = document.getElementById('apiSearch').value.trim();
    const type = document.getElementById('contentType').value;
    const tmdbType = (type === 'series') ? 'tv' : 'movie';
    const resultsDiv = document.getElementById('results');

    if (query.length < 1) { resultsDiv.innerHTML = ''; return; }

    let url;
    
    // 1. Check if it's an IMDb ID (starts with tt)
    if (query.startsWith('tt')) {
        url = `https://api.themoviedb.org/3/find/${query}?api_key=${API_KEY}&external_source=imdb_id`;
    } 
    // 2. Check if it's a TMDB ID (purely numeric)
    else if (!isNaN(query)) {
        url = `https://api.themoviedb.org/3/${tmdbType}/${query}?api_key=${API_KEY}`;
    } 
    // 3. Otherwise, search by Name
    else {
        url = `https://api.themoviedb.org/3/search/${tmdbType}?api_key=${API_KEY}&query=${encodeURIComponent(query)}`;
    }

    try {
        const res = await fetch(url);
        const data = await res.json();
        
        // Handle the different ways TMDB returns data based on the URL used
        let results = [];
        if (data.movie_results) results = data.movie_results; // From IMDb "find"
        else if (data.tv_results) results = data.tv_results;   // From IMDb "find"
        else if (data.results) results = data.results;         // From Search
        else if (data.id) results = [data];                    // From ID lookup

        resultsDiv.innerHTML = '';
        results.slice(0, 8).forEach(item => {
            const title = item.title || item.name;
            const poster = item.poster_path ? IMG_PATH + item.poster_path : 'https://via.placeholder.com/200x300';
            const year = (item.release_date || item.first_air_date || 'N/A').split('-')[0];
            
            const div = document.createElement('div');
            div.className = 'tmdb-card';
            div.innerHTML = `<img src="${poster}"><p>${title} (${year})</p>`;
            div.onclick = () => selectMovie(item, poster, year);
            resultsDiv.appendChild(div);
        });
    } catch (e) { console.error("Search failed", e); }
}
function selectMovie(item, poster, year) {
    selectedMovieData = item;
    const title = item.title || item.name;
    document.getElementById('mName').value = title;
    document.getElementById('mTmdb').value = item.id;
    document.getElementById('mImg').value = poster;
    document.getElementById('mYear').value = year;
    document.getElementById('mId').value = title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
    updateOutputs();
}

function updateOutputs() {
    const type = document.getElementById('contentType').value;
    const name = document.getElementById('mName').value;
    const id = document.getElementById('mId').value;
    const img = document.getElementById('mImg').value;
    const year = document.getElementById('mYear').value;
    const tmdb = document.getElementById('mTmdb').value;

    let jsCode = "";
    if (type === 'series') {
        const episodesRaw = document.getElementById('mEpisodes').value.split('\n').filter(l => l.trim() !== "");
        const episodesJSON = JSON.stringify(episodesRaw);
        jsCode = `"${id}": { \n  "title": "${name}", \n  "img": "${img}", \n  "tmdb": "${tmdb}", \n  "isSeries": true, \n  "episodes": ${episodesJSON} \n},`;
    } else {
        const src = document.getElementById('mSrc').value || 'LINK_HERE';
        jsCode = `"${id}": { "title": "${name}", "src": "${src}", "year": "${year}", "img": "${img}" },`;
    }

    document.getElementById('outJS').value = jsCode;
    document.getElementById('outHTML').value = `<a href="newplayer/player?id=${id}&tmdb=${tmdb}" class="movie-link" data-id="${tmdb}">
    <div class="movie-card">
        <div class="movie-poster-container"><img src="${img}" class="movie-poster"></div>
        <div class="movie-info"><h3>${name}</h3><p>${year} | ${type === 'series' ? 'Series' : 'Movie'}</p></div>
    </div>
</a>`;
}

async function triggerTelegram() {
    if (!selectedMovieData) return alert("Select content first!");
    const btn = document.querySelector('.btn-send');
    btn.innerText = "Processing...";
    
    const name = document.getElementById('mName').value;
    const poster = document.getElementById('mImg').value;
    const id = document.getElementById('mId').value;
    const type = document.getElementById('contentType').value;
    
    const message = `üé¨ *New Upload on CineView!* \n\n` +
                    `üçø *Title:* ${name}\n` +
                    `üè∑Ô∏è *Type:* ${type === 'series' ? 'Web Series' : 'Movie'}\n` +
                    `üìù *Story:* ${selectedMovieData.overview ? selectedMovieData.overview.substring(0, 120) : "Watch now on CineView!"}...\n\n` +
                    `üîó [Watch Online](https://prigames.netlify.app/movies/newplayer/player?id=${id})\n\n` +
                    `#CineView #Update`;

    try {
        await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendPhoto`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, photo: poster, caption: message, parse_mode: 'Markdown' })
        });
        alert("Sent to Telegram!");
    } catch (e) { alert("Error sending!"); }
    btn.innerText = "üöÄ Post to Telegram";
}
</script>

</body>
</html>

