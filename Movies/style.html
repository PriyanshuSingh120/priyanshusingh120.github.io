<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CineView Admin Pro | Abyss & Telegram</title>
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0b0f1a; color: #e2e8f0; overflow-x: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .custom-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        input, select, textarea { background: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; }
        input:focus { border-color: #3b82f6 !important; ring: 1px #3b82f6; }
        
        .folder-card { border-left: 4px solid #fbbf24; background: rgba(251, 191, 36, 0.1) !important; }
        .file-card { border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.1) !important; }
        
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 12px; z-index: 9999;
            font-weight: bold; font-size: 11px; text-transform: uppercase;
            display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .card-active:active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body class="p-4 md:p-10 font-sans">

<div id="toast" class="bg-blue-600 text-white tracking-widest">Notification</div>

<div class="max-w-5xl mx-auto space-y-6">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-indigo-500 tracking-tighter">CINEVIEW PRO</h1>
            <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Master Admin ‚Ä¢ Media Manager</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column: Search & Explorer -->
        <div class="space-y-6">
            <!-- Mode & TMDB Search -->
            <div class="glass-card rounded-3xl p-6 space-y-4">
                <div class="flex gap-2">
                    <select id="contentType" onchange="toggleType()" class="w-32 p-3 rounded-xl text-xs font-bold outline-none cursor-pointer">
                        <option value="movie">Movie</option>
                        <option value="series">Series</option>
                    </select>
                    <input type="text" id="apiSearch" oninput="searchTMDB()" placeholder="Search Movie/Series on TMDB..." class="flex-grow p-3 rounded-xl text-sm outline-none">
                </div>
                <div id="tmdbResults" class="flex gap-3 overflow-x-auto pb-4 custom-scroll min-h-[140px]">
                    <p class="text-slate-600 text-xs italic py-10 w-full text-center">Type title to search...</p>
                </div>
                <div id="seasonWrapper" class="hidden bg-indigo-500/10 p-4 rounded-2xl border border-indigo-500/20">
                    <label class="text-[10px] font-bold text-indigo-400 uppercase mb-2 block">Season Selector</label>
                    <select id="seasonPicker" onchange="applySeason(this.value)" class="w-full p-3 rounded-xl text-xs outline-none"></select>
                </div>
            </div>

            <!-- Abyss Library -->
            <div class="glass-card rounded-3xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Abyss Library</h3>
                        <button id="abyssBack" onclick="fetchAbyss(null)" class="hidden text-[9px] bg-slate-800 px-2 py-1 rounded text-white border border-slate-700">‚Üê ROOT</button>
                    </div>
                    <button onclick="fetchAbyss(currentFolderId)" class="text-[10px] text-blue-500 font-bold uppercase hover:underline">Refresh</button>
                </div>
                <div id="abyssList" class="flex gap-3 overflow-x-auto pb-4 custom-scroll min-h-[110px]">
                    <p class="text-slate-700 text-[10px] italic">Accessing resources...</p>
                </div>
                <div id="pathLabel" class="text-[9px] text-slate-500 mt-2 uppercase tracking-tighter italic font-bold">Location: Root</div>
            </div>
        </div>

        <!-- Right Column: Meta Form -->
        <div class="glass-card rounded-3xl p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Title</label>
                    <input type="text" id="mName" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Slug / ID</label>
                    <input type="text" id="mId" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Year</label>
                    <input type="text" id="mYear" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
            </div>

            <!-- Genre Field -->
            <div>
                <label class="text-[10px] font-bold text-slate-500 uppercase">Genres (Comma separated)</label>
                <input type="text" id="mGenre" placeholder="Action, Animated, Sci-Fi" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
            </div>

            <!-- Movie Box -->
            <div id="movieBox">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Embed Link (Abyss)</label>
                <input type="text" id="mSrc" placeholder="Link appears here on click..." oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
            </div>

            <!-- Series Box -->
            <div id="seriesBox" class="hidden">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Episode Links</label>
                    <button onclick="clearEps()" class="text-[8px] text-red-500 font-bold uppercase">Clear List</button>
                </div>
                <textarea id="mEpisodes" rows="4" oninput="updateOutputs()" placeholder="Episodes will append here line-by-line..." class="w-full p-3 rounded-xl text-xs outline-none font-mono"></textarea>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Poster URL</label>
                    <input type="text" id="mImg" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
            </div>
            
            <input type="hidden" id="mTmdb">

            <!-- Telegram Action -->
            <button id="telegramBtn" onclick="triggerTelegram()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-900/30 transition-all uppercase tracking-widest text-sm flex items-center justify-center gap-3">
                üì¢ SEND TO TELEGRAM
            </button>
        </div>
    </div>

    <!-- Codes Output Area -->
    <div class="glass-card rounded-3xl p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block tracking-widest">JavaScript Data Object</label>
            <textarea id="outJS" rows="8" readonly class="w-full p-4 rounded-2xl text-[10px] font-mono text-blue-400 outline-none" onclick="this.select()"></textarea>
        </div>
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block tracking-widest">HTML Player Snippet</label>
            <textarea id="outHTML" rows="8" readonly class="w-full p-4 rounded-2xl text-[10px] font-mono text-indigo-400 outline-none" onclick="this.select()"></textarea>
        </div>
    </div>
</div>

<script>
/**
 * Configuration & State
 */
const TMDB_API = 'dc691868b09daaabe9acc238ed898cf7';
const ABYSS_API = '391ea7f7e967589e017d3b3924b1c33f';
const TG_TOKEN = '7287243554:AAHa43wD_V2roGLep1aQgKHn0vqXHYlFp-M';
const TG_CHAT = '-1003605866054';
const IMG_BASE = 'https://image.tmdb.org/t/p/w500';

// TMDB Genre Mapping - Animation mapped to "Animated"
const GENRE_MAP = {
    28: "Action", 12: "Adventure", 16: "Animated", 35: "Comedy", 80: "Crime", 
    99: "Documentary", 18: "Drama", 10751: "Family", 14: "Fantasy", 36: "History", 
    27: "Horror", 10402: "Music", 9648: "Mystery", 10749: "Romance", 878: "Sci-Fi", 
    10770: "TV Movie", 53: "Thriller", 10752: "War", 37: "Western", 10759: "Action & Adventure",
    10762: "Kids", 10763: "News", 10764: "Reality", 10765: "Sci-Fi & Fantasy", 
    10766: "Soap", 10767: "Talk", 10768: "War & Politics"
};

let currentSeasons = [];
let selectedMovie = null;
let currentFolderId = null;

window.onload = () => {
    fetchAbyss();
};

function showToast(msg, color = "bg-blue-600") {
    const toast = document.getElementById('toast');
    toast.innerText = msg;
    toast.className = `${color} text-white tracking-widest px-6 py-3 rounded-xl`;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

function toggleType() {
    const isSeries = document.getElementById('contentType').value === 'series';
    document.getElementById('movieBox').classList.toggle('hidden', isSeries);
    document.getElementById('seriesBox').classList.toggle('hidden', !isSeries);
    document.getElementById('seasonWrapper').classList.add('hidden');
    currentFolderId = null;
    fetchAbyss();
    updateOutputs();
}

function clearEps() {
    document.getElementById('mEpisodes').value = '';
    updateOutputs();
}

async function fetchAbyss(folderId = null) {
    currentFolderId = folderId;
    const list = document.getElementById('abyssList');
    const backBtn = document.getElementById('abyssBack');
    const type = document.getElementById('contentType').value;
    const pathLabel = document.getElementById('pathLabel');
    
    list.innerHTML = '<p class="text-blue-500 animate-pulse text-[10px] uppercase font-bold py-10 w-full text-center">Syncing Abyss...</p>';
    
    if (type === 'movie') {
        backBtn.classList.add('hidden');
        pathLabel.innerText = "Browsing: Root Files";
        try {
            const res = await puter.net.fetch(`https://api.abyss.to/v1/resources?key=${ABYSS_API}&type=files&maxResults=20`);
            const data = await res.json();
            list.innerHTML = '';
            data.items.forEach(file => {
                const div = document.createElement('div');
                div.className = 'flex-shrink-0 w-36 glass-card p-3 rounded-2xl cursor-pointer hover:border-blue-500 transition-all file-card';
                div.onclick = () => {
                    document.getElementById('mSrc').value = `https://short.icu/${file.id}`;
                    updateOutputs();
                    showToast("Movie Link Added!");
                };
                div.innerHTML = `<div class="text-[8px] text-blue-500 font-black mb-1 uppercase tracking-widest">File</div><div class="text-[10px] font-bold truncate">${file.name}</div>`;
                list.appendChild(div);
            });
        } catch (e) { list.innerHTML = '<p class="text-red-500 text-[10px] py-10 w-full text-center">Error loading Abyss.</p>'; }
        return;
    }

    folderId ? backBtn.classList.remove('hidden') : backBtn.classList.add('hidden');
    pathLabel.innerText = folderId ? `Location: Subfolder (${folderId})` : "Location: Root folders";

    try {
        let url = `https://api.abyss.to/v1/resources?key=${ABYSS_API}&maxResults=100`;
        if (folderId) url += `&folderId=${folderId}`;
        const res = await puter.net.fetch(url);
        const data = await res.json();
        list.innerHTML = '';
        data.items.forEach(item => {
            const isFolder = item.isDir === true;
            if (!folderId && !isFolder) return;
            if (folderId && isFolder) return;
            const div = document.createElement('div');
            div.className = `flex-shrink-0 w-36 glass-card p-3 rounded-2xl cursor-pointer hover:border-slate-500 transition-all card-active ${isFolder ? 'folder-card' : 'file-card'}`;
            div.onclick = () => {
                if (isFolder) fetchAbyss(item.id);
                else {
                    const embedLink = `https://short.icu/${item.id}`;
                    const epArea = document.getElementById('mEpisodes');
                    const current = epArea.value.trim();
                    epArea.value = current ? (current + '\n' + embedLink) : embedLink;
                    updateOutputs();
                    showToast("Episode Added!");
                }
            };
            div.innerHTML = `<div class="text-[18px] mb-1">${isFolder ? 'üìÅ' : 'üéûÔ∏è'}</div><div class="text-[10px] font-bold truncate">${item.name}</div>`;
            list.appendChild(div);
        });
    } catch (e) { list.innerHTML = '<p class="text-red-500 text-[10px] py-10 w-full text-center font-bold">API Sync Failed.</p>'; }
}

async function searchTMDB() {
    const query = document.getElementById('apiSearch').value.trim();
    const type = document.getElementById('contentType').value === 'series' ? 'tv' : 'movie';
    const resDiv = document.getElementById('tmdbResults');
    if (query.length < 2) return;
    try {
        const res = await fetch(`https://api.themoviedb.org/3/search/${type}?api_key=${TMDB_API}&query=${encodeURIComponent(query)}`);
        const data = await res.json();
        resDiv.innerHTML = '';
        data.results.slice(0, 10).forEach(item => {
            const card = document.createElement('div');
            card.className = 'flex-shrink-0 w-24 text-center space-y-2 cursor-pointer group';
            const poster = item.poster_path ? IMG_BASE + item.poster_path : 'https://via.placeholder.com/200x300';
            const year = (item.release_date || item.first_air_date || 'N/A').split('-')[0];
            card.onclick = () => selectMovie(item, poster, year);
            card.innerHTML = `<img src="${poster}" class="w-full h-36 object-cover rounded-xl border border-slate-800 group-hover:border-blue-500 transition-all shadow-lg"><p class="text-[9px] font-bold truncate uppercase tracking-tighter">${item.title || item.name}</p>`;
            resDiv.appendChild(card);
        });
    } catch (e) {}
}

async function selectMovie(item, poster, year) {
    selectedMovie = item;
    const title = item.title || item.name;
    document.getElementById('mName').value = title;
    document.getElementById('mImg').value = poster;
    document.getElementById('mYear').value = year;
    document.getElementById('mTmdb').value = item.id;
    document.getElementById('mId').value = title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');

    if (item.genre_ids) {
        const names = item.genre_ids.map(id => GENRE_MAP[id] || "").filter(n => n !== "");
        document.getElementById('mGenre').value = names.join(", ");
    }

    if (document.getElementById('contentType').value === 'series') {
        const res = await fetch(`https://api.themoviedb.org/3/tv/${item.id}?api_key=${TMDB_API}`);
        const data = await res.json();
        currentSeasons = data.seasons;
        const picker = document.getElementById('seasonPicker');
        picker.innerHTML = '<option value="">-- Choose Season --</option>';
        currentSeasons.forEach(s => {
            if (s.season_number === 0) return;
            picker.innerHTML += `<option value="${s.season_number}">${s.name} (${s.episode_count} Eps)</option>`;
        });
        document.getElementById('seasonWrapper').classList.remove('hidden');
    }
    updateOutputs();
}

function applySeason(num) {
    if(!num) return;
    const s = currentSeasons.find(i => i.season_number == num);
    document.getElementById('mName').value = `${selectedMovie.name} - Season ${num}`;
    document.getElementById('mId').value = `${selectedMovie.name.toLowerCase().replace(/[^a-z0-9]/g, '-')}-s${num}`;
    if(s.poster_path) document.getElementById('mImg').value = IMG_BASE + s.poster_path;
    updateOutputs();
}

function updateOutputs() {
    const type = document.getElementById('contentType').value;
    const name = document.getElementById('mName').value;
    const id = document.getElementById('mId').value;
    const img = document.getElementById('mImg').value;
    const year = document.getElementById('mYear').value;
    const tmdb = document.getElementById('mTmdb').value;
    const genre = document.getElementById('mGenre').value;

    let movieObj = { title: name, img: img, year: year, genre: genre, tmdb: tmdb, type: type };
    if (type === 'series') movieObj.episodes = document.getElementById('mEpisodes').value.split('\n').filter(l => l.trim() !== "");
    else movieObj.src = document.getElementById('mSrc').value;

    document.getElementById('outJS').value = `"${id}": ${JSON.stringify(movieObj, null, 2)},`;
    document.getElementById('outHTML').value = `<a href="newplayer/player?id=${id}&tmdb=${tmdb}" class="movie-link" data-id="${tmdb}">
    <div class="movie-card">
        <div class="movie-poster-container"><img src="${img}" class="movie-poster"></div>
        <div class="movie-info">
            <h3>${name}</h3>
            <p>${year} | ${genre || (type === 'movie' ? 'Movie' : 'Web Series')}</p>
        </div>
    </div>
</a>`;
}

async function triggerTelegram() {
    if (!selectedMovie) return showToast("Select a movie first!", "bg-orange-600");
    const name = document.getElementById('mName').value;
    const img = document.getElementById('mImg').value;
    const id = document.getElementById('mId').value;
    const genre = document.getElementById('mGenre').value;
    const msg = `üé¨ *NEW ON CINEVIEW* \n\nüçø *${name}*\nüè∑Ô∏è ${genre}\n\nüîó [WATCH NOW](https://prigames.netlify.app/movies/newplayer/player?id=${id})`;
    try {
        const res = await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendPhoto`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: TG_CHAT, photo: img, caption: msg, parse_mode: 'Markdown' })
        });
        if (res.ok) showToast("Posted to Telegram!", "bg-green-600");
        else showToast("Telegram API Error", "bg-red-600");
    } catch (e) { showToast("Telegram Failed", "bg-red-600"); }
}
</script>
</body>
</html>

