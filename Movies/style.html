<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CineView Admin Pro | Abyss & GitHub Sync</title>
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0b0f1a; color: #e2e8f0; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .custom-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        input, select, textarea { background: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; }
        input:focus { border-color: #3b82f6 !important; ring: 1px #3b82f6; }
    </style>
</head>
<body class="p-4 md:p-10 font-sans">

<div class="max-w-5xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-indigo-500 tracking-tighter">CINEVIEW PRO</h1>
            <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Master Admin ‚Ä¢ Abyss & GitHub Auto-Sync</p>
        </div>
        <div id="syncStatus" class="hidden flex items-center gap-2 bg-blue-500/10 text-blue-400 border border-blue-500/20 px-4 py-2 rounded-full text-[10px] font-bold uppercase animate-pulse">
            <span class="w-2 h-2 bg-blue-500 rounded-full"></span> GitHub Uploading...
        </div>
    </div>

    <!-- GitHub Config -->
    <div class="glass-card rounded-3xl p-6">
        <button onclick="document.getElementById('ghConfig').classList.toggle('hidden')" class="w-full text-left text-xs font-bold text-slate-400 uppercase flex justify-between items-center">
            <span>GitHub Configuration</span>
            <span class="bg-slate-800 p-1 px-2 rounded">SETTINGS ‚ñº</span>
        </button>
        <div id="ghConfig" class="hidden mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="password" id="ghToken" placeholder="GitHub PAT (Fine-grained Token)" class="w-full p-3 rounded-xl text-xs outline-none">
            <input type="text" id="ghUser" placeholder="GitHub Username" class="w-full p-3 rounded-xl text-xs outline-none">
            <input type="text" id="ghRepo" placeholder="Repository Name" class="w-full p-3 rounded-xl text-xs outline-none">
            <input type="text" id="ghPath" placeholder="Data Path (e.g. data/movies.js)" class="w-full p-3 rounded-xl text-xs outline-none">
            <button onclick="saveConfig()" class="md:col-span-2 bg-slate-800 hover:bg-slate-700 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition">Save Locally</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left: Search & Content Selection -->
        <div class="space-y-6">
            <div class="glass-card rounded-3xl p-6 space-y-4">
                <div class="flex gap-2">
                    <select id="contentType" onchange="toggleType()" class="w-32 p-3 rounded-xl text-xs font-bold outline-none">
                        <option value="movie">Movie</option>
                        <option value="series">Series</option>
                    </select>
                    <input type="text" id="apiSearch" oninput="searchTMDB()" placeholder="Search Movie or TV Series..." class="flex-grow p-3 rounded-xl text-sm outline-none">
                </div>
                <div id="tmdbResults" class="flex gap-3 overflow-x-auto pb-4 custom-scroll min-h-[160px]">
                    <p class="text-slate-600 text-xs italic py-10 w-full text-center">Type above to search TMDB...</p>
                </div>
                <div id="seasonWrapper" class="hidden bg-indigo-500/10 p-4 rounded-2xl border border-indigo-500/20">
                    <label class="text-[10px] font-bold text-indigo-400 uppercase mb-2 block">Select Season</label>
                    <select id="seasonPicker" onchange="applySeason(this.value)" class="w-full p-3 rounded-xl text-xs outline-none"></select>
                </div>
            </div>

            <!-- Abyss Library -->
            <div class="glass-card rounded-3xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Abyss Library</h3>
                    <button onclick="fetchAbyss()" class="text-[10px] text-blue-500 font-bold uppercase hover:underline">Refresh</button>
                </div>
                <div id="abyssList" class="flex gap-3 overflow-x-auto pb-4 custom-scroll min-h-[100px]">
                    <p class="text-slate-700 text-[10px] italic">No videos loaded.</p>
                </div>
            </div>
        </div>

        <!-- Right: Form & Metadata -->
        <div class="glass-card rounded-3xl p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Title</label>
                    <input type="text" id="mName" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Slug / ID</label>
                    <input type="text" id="mId" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
            </div>

            <div id="movieBox">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Embed Source (short.icu)</label>
                <input type="text" id="mSrc" placeholder="https://short.icu/embed/..." oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
            </div>

            <div id="seriesBox" class="hidden">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Episode Links (One per line)</label>
                <textarea id="mEpisodes" rows="4" oninput="updateOutputs()" placeholder="Paste Abyss links here..." class="w-full p-3 rounded-xl text-xs outline-none font-mono"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Poster URL</label>
                    <input type="text" id="mImg" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Year</label>
                    <input type="text" id="mYear" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
            </div>
            
            <input type="hidden" id="mTmdb">

            <button id="syncBtn" onclick="triggerGHSync()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-900/30 transition-all uppercase tracking-widest text-sm">
                üöÄ Auto-Sync to GitHub
            </button>
            <button onclick="triggerTelegram()" class="w-full border border-slate-800 text-slate-500 py-3 rounded-2xl text-[10px] font-bold uppercase tracking-widest hover:bg-slate-800 transition">
                Send Notification to Telegram
            </button>
        </div>
    </div>

    <!-- Final Codes -->
    <div class="glass-card rounded-3xl p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block tracking-widest">JavaScript Data Code</label>
            <textarea id="outJS" rows="6" readonly class="w-full p-4 rounded-2xl text-[10px] font-mono text-blue-400 outline-none" onclick="this.select()"></textarea>
        </div>
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block tracking-widest">HTML Player List Code</label>
            <textarea id="outHTML" rows="6" readonly class="w-full p-4 rounded-2xl text-[10px] font-mono text-indigo-400 outline-none" onclick="this.select()"></textarea>
        </div>
    </div>
</div>

<script>
const TMDB_API = 'dc691868b09daaabe9acc238ed898cf7';
const ABYSS_API = '391ea7f7e967589e017d3b3924b1c33f';
const TG_TOKEN = '7287243554:AAHa43wD_V2roGLep1aQgKHn0vqXHYlFp-M';
const TG_CHAT = '-1003605866054';
const IMG_BASE = 'https://image.tmdb.org/t/p/w500';

let currentSeasons = [];
let selectedMovie = null;

window.onload = () => {
    document.getElementById('ghToken').value = localStorage.getItem('ghToken') || '';
    document.getElementById('ghUser').value = localStorage.getItem('ghUser') || '';
    document.getElementById('ghRepo').value = localStorage.getItem('ghRepo') || '';
    document.getElementById('ghPath').value = localStorage.getItem('ghPath') || '';
};

function saveConfig() {
    localStorage.setItem('ghToken', document.getElementById('ghToken').value);
    localStorage.setItem('ghUser', document.getElementById('ghUser').value);
    localStorage.setItem('ghRepo', document.getElementById('ghRepo').value);
    localStorage.setItem('ghPath', document.getElementById('ghPath').value);
    alert("Settings Saved!");
}

function toggleType() {
    const isSeries = document.getElementById('contentType').value === 'series';
    document.getElementById('movieBox').classList.toggle('hidden', isSeries);
    document.getElementById('seriesBox').classList.toggle('hidden', !isSeries);
    document.getElementById('seasonWrapper').classList.add('hidden');
    updateOutputs();
}

// --- Abyss Section ---
async function fetchAbyss() {
    const list = document.getElementById('abyssList');
    list.innerHTML = '<p class="text-blue-500 animate-pulse text-[10px] uppercase font-bold">Accessing Cloud...</p>';
    try {
        const res = await puter.net.fetch(`https://api.abyss.to/v1/resources?key=${ABYSS_API}&type=files&maxResults=20`);
        const data = await res.json();
        list.innerHTML = '';
        data.items.forEach(file => {
            const div = document.createElement('div');
            div.className = 'flex-shrink-0 w-36 glass-card p-3 rounded-2xl cursor-pointer hover:border-blue-500 transition-all';
            div.onclick = () => {
                // ABYSS EMBED DOMAIN: short.icu
                document.getElementById('mSrc').value = `https://short.icu/${file.id}`;
                updateOutputs();
            };
            div.innerHTML = `
                <div class="text-[8px] text-blue-500 font-black mb-1">FILE</div>
                <div class="text-[10px] font-bold truncate">${file.name}</div>
                <div class="text-[8px] text-slate-500 mt-1 uppercase">Click to Embed</div>
            `;
            list.appendChild(div);
        });
    } catch (e) { list.innerHTML = '<p class="text-red-500 text-[10px]">Error loading Abyss.</p>'; }
}

// --- TMDB Section ---
async function searchTMDB() {
    const query = document.getElementById('apiSearch').value.trim();
    const type = document.getElementById('contentType').value === 'series' ? 'tv' : 'movie';
    const resDiv = document.getElementById('tmdbResults');
    if (query.length < 2) return;

    try {
        const res = await fetch(`https://api.themoviedb.org/3/search/${type}?api_key=${TMDB_API}&query=${encodeURIComponent(query)}`);
        const data = await res.json();
        resDiv.innerHTML = '';
        data.results.slice(0, 10).forEach(item => {
            const card = document.createElement('div');
            card.className = 'flex-shrink-0 w-24 text-center space-y-2 cursor-pointer group';
            const poster = item.poster_path ? IMG_BASE + item.poster_path : 'https://via.placeholder.com/200x300';
            const year = (item.release_date || item.first_air_date || 'N/A').split('-')[0];
            card.onclick = () => selectMovie(item, poster, year);
            card.innerHTML = `
                <img src="${poster}" class="w-full h-36 object-cover rounded-xl border border-slate-800 group-hover:border-blue-500 transition-all">
                <p class="text-[9px] font-bold truncate uppercase tracking-tighter">${item.title || item.name}</p>
            `;
            resDiv.appendChild(card);
        });
    } catch (e) {}
}

async function selectMovie(item, poster, year) {
    selectedMovie = item;
    const title = item.title || item.name;
    document.getElementById('mName').value = title;
    document.getElementById('mImg').value = poster;
    document.getElementById('mYear').value = year;
    document.getElementById('mTmdb').value = item.id;
    document.getElementById('mId').value = title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');

    if (document.getElementById('contentType').value === 'series') {
        const res = await fetch(`https://api.themoviedb.org/3/tv/${item.id}?api_key=${TMDB_API}`);
        const data = await res.json();
        currentSeasons = data.seasons;
        const picker = document.getElementById('seasonPicker');
        picker.innerHTML = '<option value="">-- Choose Season --</option>';
        currentSeasons.forEach(s => {
            if (s.season_number === 0) return;
            picker.innerHTML += `<option value="${s.season_number}">${s.name} (${s.episode_count} Eps)</option>`;
        });
        document.getElementById('seasonWrapper').classList.remove('hidden');
    }
    updateOutputs();
}

function applySeason(num) {
    if(!num) return;
    const s = currentSeasons.find(i => i.season_number == num);
    document.getElementById('mName').value = `${selectedMovie.name} - Season ${num}`;
    document.getElementById('mId').value = `${selectedMovie.name.toLowerCase().replace(/[^a-z0-9]/g, '-')}-s${num}`;
    if(s.poster_path) document.getElementById('mImg').value = IMG_BASE + s.poster_path;
    updateOutputs();
}

function updateOutputs() {
    const type = document.getElementById('contentType').value;
    const name = document.getElementById('mName').value;
    const id = document.getElementById('mId').value;
    const img = document.getElementById('mImg').value;
    const year = document.getElementById('mYear').value;
    const tmdb = document.getElementById('mTmdb').value;

    let movieObj = { title: name, img: img, year: year, tmdb: tmdb, type: type };
    if (type === 'series') {
        movieObj.episodes = document.getElementById('mEpisodes').value.split('\n').filter(l => l.trim() !== "");
    } else {
        movieObj.src = document.getElementById('mSrc').value;
    }

    // JS CONFIG OUTPUT
    document.getElementById('outJS').value = `"${id}": ${JSON.stringify(movieObj, null, 2)},`;

    // HTML PLAYER LIST OUTPUT
    const htmlSnippet = `<a href="newplayer/player?id=${id}&tmdb=${tmdb}" class="movie-link" data-id="${tmdb}">
    <div class="movie-card">
        <div class="movie-poster-container"><img src="${img}" class="movie-poster"></div>
        <div class="movie-info">
            <h3>${name}</h3>
            <p>${year} | ${type === 'movie' ? 'Movie' : 'Web Series'}</p>
        </div>
    </div>
</a>`;
    document.getElementById('outHTML').value = htmlSnippet;
}

// --- GitHub Auto-Sync ---
async function triggerGHSync() {
    const btn = document.getElementById('syncBtn');
    const status = document.getElementById('syncStatus');
    const token = document.getElementById('ghToken').value;
    const user = document.getElementById('ghUser').value;
    const repo = document.getElementById('ghRepo').value;
    const path = document.getElementById('ghPath').value;

    if (!token || !selectedMovie) return alert("Select Movie & Setup GitHub!");

    btn.disabled = true;
    btn.innerText = "Syncing...";
    status.classList.remove('hidden');

    try {
        const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
        const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
        const data = await res.json();
        
        let content = atob(data.content);
        const newEntry = document.getElementById('outJS').value;
        
        // Injecting into the object structure
        const lastBrace = content.lastIndexOf('}');
        const updatedContent = content.slice(0, lastBrace) + `  ${newEntry}\n` + content.slice(lastBrace);

        const push = await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: `Auto-Update: ${document.getElementById('mName').value}`,
                content: btoa(unescape(encodeURIComponent(updatedContent))),
                sha: data.sha
            })
        });

        if (push.ok) alert("üöÄ GitHub Website Updated Successfully!");
        else alert("GitHub Error: Access Token might be expired.");
    } catch (e) { alert("Sync Error: " + e.message); }
    
    btn.disabled = false;
    btn.innerText = "üöÄ Auto-Sync to GitHub";
    status.classList.add('hidden');
}

async function triggerTelegram() {
    const name = document.getElementById('mName').value;
    const img = document.getElementById('mImg').value;
    const id = document.getElementById('mId').value;
    const story = selectedMovie.overview ? selectedMovie.overview.substring(0, 120) : "Enjoy high quality streaming!";
    const msg = `üé¨ *NEW ON CINEVIEW* \n\nüçø *Title:* ${name}\n‚ú® *Story:* ${story}...\n\nüîó [WATCH NOW](https://prigames.netlify.app/movies/newplayer/player?id=${id})\n\n#Update #CineView`;

    try {
        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendPhoto`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: TG_CHAT, photo: img, caption: msg, parse_mode: 'Markdown' })
        });
        alert("Sent to Telegram Channel!");
    } catch (e) { alert("Telegram Error"); }
}
</script>
</body>
</html>
