<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CineView Admin Pro | Abyss & Telegram</title>
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0b0f1a; color: #e2e8f0; overflow-x: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .custom-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        input, select, textarea { background: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; }
        input:focus { border-color: #3b82f6 !important; ring: 1px #3b82f6; }
        
        .folder-card { border-left: 4px solid #fbbf24; background: rgba(251, 191, 36, 0.1) !important; }
        .file-card { border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.1) !important; }
        
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 12px; z-index: 9999;
            font-weight: bold; font-size: 11px; text-transform: uppercase;
            display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="p-4 md:p-10 font-sans">

<div id="toast" class="bg-blue-600 text-white tracking-widest">Notification</div>

<div class="max-w-5xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-indigo-500 tracking-tighter">CINEVIEW PRO</h1>
            <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Master Admin ‚Ä¢ Abyss & Telegram Manager</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column -->
        <div class="space-y-6">
            <!-- Mode & TMDB Search -->
            <div class="glass-card rounded-3xl p-6 space-y-4">
                <div class="flex gap-2">
                    <select id="contentType" onchange="toggleType()" class="w-32 p-3 rounded-xl text-xs font-bold outline-none cursor-pointer">
                        <option value="movie">Movie</option>
                        <option value="series">Series</option>
                    </select>
                    <input type="text" id="apiSearch" oninput="searchTMDB()" placeholder="Search TMDB..." class="flex-grow p-3 rounded-xl text-sm outline-none">
                </div>
                <div id="tmdbResults" class="flex gap-3 overflow-x-auto pb-4 custom-scroll min-h-[140px]">
                    <p class="text-slate-600 text-xs italic py-8 w-full text-center">Find content on TMDB...</p>
                </div>
                <div id="seasonWrapper" class="hidden bg-indigo-500/10 p-4 rounded-2xl border border-indigo-500/20">
                    <label class="text-[10px] font-bold text-indigo-400 uppercase mb-2 block">Season Selector</label>
                    <select id="seasonPicker" onchange="applySeason(this.value)" class="w-full p-3 rounded-xl text-xs outline-none"></select>
                </div>
            </div>

            <!-- Abyss Remote Upload -->
            <div class="glass-card rounded-3xl p-6 bg-gradient-to-br from-slate-800/40 to-transparent">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                    <span>‚òÅÔ∏è Remote Upload to Abyss</span>
                </h3>
                <div class="flex flex-col gap-3">
                    <input type="text" id="remoteUrl" placeholder="Paste Direct Download Link..." class="w-full p-3 rounded-xl text-xs outline-none">
                    <button id="remoteBtn" onclick="triggerRemoteUpload()" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-xl text-[10px] uppercase tracking-widest transition-all">
                        Start Remote Transfer
                    </button>
                </div>
            </div>

            <!-- Abyss Explorer -->
            <div class="glass-card rounded-3xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Abyss Library</h3>
                        <button id="abyssBack" onclick="fetchAbyss(null)" class="hidden text-[9px] bg-slate-800 px-2 py-1 rounded text-white border border-slate-700">‚Üê ROOT</button>
                    </div>
                    <button onclick="fetchAbyss(currentFolderId)" class="text-[10px] text-blue-500 font-bold uppercase hover:underline">Refresh</button>
                </div>
                <div id="abyssList" class="flex gap-3 overflow-x-auto pb-4 custom-scroll min-h-[110px]">
                    <p class="text-slate-700 text-[10px] italic">Accessing resources...</p>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="glass-card rounded-3xl p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Title</label>
                    <input type="text" id="mName" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Slug / ID</label>
                    <input type="text" id="mId" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
            </div>

            <div id="movieBox">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Embed Source (short.icu)</label>
                <input type="text" id="mSrc" placeholder="Click a file below..." oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
            </div>

            <div id="seriesBox" class="hidden">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Episode List</label>
                    <button onclick="document.getElementById('mEpisodes').value = ''; updateOutputs();" class="text-[9px] text-red-500 font-bold uppercase">Clear</button>
                </div>
                <textarea id="mEpisodes" rows="4" oninput="updateOutputs()" placeholder="Files selected in folders will appear here..." class="w-full p-3 rounded-xl text-xs outline-none font-mono"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Poster URL</label>
                    <input type="text" id="mImg" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Year</label>
                    <input type="text" id="mYear" oninput="updateOutputs()" class="w-full p-3 rounded-xl text-sm outline-none">
                </div>
            </div>
            
            <input type="hidden" id="mTmdb">

            <!-- TELEGRAM ONLY BUTTON -->
            <button id="telegramBtn" onclick="triggerTelegram()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-900/30 transition-all uppercase tracking-widest text-sm flex items-center justify-center gap-3">
                üì¢ SEND TO TELEGRAM
            </button>
        </div>
    </div>

    <!-- Live Preview -->
    <div class="glass-card rounded-3xl p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block tracking-widest">JavaScript Code (Copy Manually)</label>
            <textarea id="outJS" rows="6" readonly class="w-full p-4 rounded-2xl text-[10px] font-mono text-blue-400 outline-none" onclick="this.select()"></textarea>
        </div>
        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block tracking-widest">HTML Snippet</label>
            <textarea id="outHTML" rows="6" readonly class="w-full p-4 rounded-2xl text-[10px] font-mono text-indigo-400 outline-none" onclick="this.select()"></textarea>
        </div>
    </div>
</div>

<script>
const TMDB_API = 'dc691868b09daaabe9acc238ed898cf7';
const ABYSS_API = '391ea7f7e967589e017d3b3924b1c33f';
const TG_TOKEN = '7287243554:AAHa43wD_V2roGLep1aQgKHn0vqXHYlFp-M';
const TG_CHAT = '-1003605866054';
const IMG_BASE = 'https://image.tmdb.org/t/p/w500';

let currentSeasons = [];
let selectedMovie = null;
let currentFolderId = null;

window.onload = () => {
    fetchAbyss();
};

function showToast(msg, color = "bg-blue-600") {
    const toast = document.getElementById('toast');
    toast.innerText = msg;
    toast.className = `${color} text-white tracking-widest px-6 py-3 rounded-xl`;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

function toggleType() {
    const isSeries = document.getElementById('contentType').value === 'series';
    document.getElementById('movieBox').classList.toggle('hidden', isSeries);
    document.getElementById('seriesBox').classList.toggle('hidden', !isSeries);
    document.getElementById('seasonWrapper').classList.add('hidden');
    currentFolderId = null;
    fetchAbyss();
    updateOutputs();
}

// --- Abyss Explorer Logic ---
async function fetchAbyss(folderId = null) {
    currentFolderId = folderId;
    const list = document.getElementById('abyssList');
    const backBtn = document.getElementById('abyssBack');
    const type = document.getElementById('contentType').value;
    
    list.innerHTML = '<p class="text-blue-500 animate-pulse text-[10px] uppercase font-bold py-10 w-full text-center">Loading Abyss...</p>';
    
    // Movie Mode Logic
    if (type === 'movie') {
        backBtn.classList.add('hidden');
        try {
            const res = await puter.net.fetch(`https://api.abyss.to/v1/resources?key=${ABYSS_API}&type=files&maxResults=20`);
            const data = await res.json();
            list.innerHTML = '';
            data.items.forEach(file => {
                const div = document.createElement('div');
                div.className = 'flex-shrink-0 w-36 glass-card p-3 rounded-2xl cursor-pointer hover:border-blue-500 transition-all file-card';
                div.onclick = () => {
                    document.getElementById('mSrc').value = `https://short.icu/${file.id}`;
                    updateOutputs();
                };
                div.innerHTML = `
                    <div class="text-[8px] text-blue-500 font-black mb-1 tracking-widest uppercase">File</div>
                    <div class="text-[10px] font-bold truncate">${file.name}</div>
                `;
                list.appendChild(div);
            });
        } catch (e) { list.innerHTML = '<p class="text-red-500 text-[10px] py-10 w-full text-center">Error loading Abyss.</p>'; }
        return;
    }

    // Series Mode Logic
    folderId ? backBtn.classList.remove('hidden') : backBtn.classList.add('hidden');
    try {
        let url = `https://api.abyss.to/v1/resources?key=${ABYSS_API}&maxResults=100`;
        if (folderId) url += `&folderId=${folderId}`;
        const res = await puter.net.fetch(url);
        const data = await res.json();
        list.innerHTML = '';
        data.items.forEach(item => {
            const isFolder = item.isDir === true;
            if (!folderId && !isFolder) return;
            if (folderId && isFolder) return;
            const div = document.createElement('div');
            div.className = `flex-shrink-0 w-36 glass-card p-3 rounded-2xl cursor-pointer hover:border-slate-500 transition-all ${isFolder ? 'folder-card' : 'file-card'}`;
            div.onclick = () => {
                if (isFolder) fetchAbyss(item.id);
                else {
                    const embedLink = `https://short.icu/${item.id}`;
                    const epArea = document.getElementById('mEpisodes');
                    epArea.value += (epArea.value ? '\n' : '') + embedLink;
                    updateOutputs();
                }
            };
            div.innerHTML = `
                <div class="text-[18px] mb-1">${isFolder ? 'üìÅ' : 'üéûÔ∏è'}</div>
                <div class="text-[10px] font-bold truncate">${item.name}</div>
            `;
            list.appendChild(div);
        });
    } catch (e) { list.innerHTML = '<p class="text-red-500 text-[10px] py-10 w-full text-center">Sync Failed.</p>'; }
}

// --- Abyss Remote URL Upload ---
async function triggerRemoteUpload() {
    const urlInput = document.getElementById('remoteUrl');
    const btn = document.getElementById('remoteBtn');
    const url = urlInput.value.trim();

    if (!url) return showToast("Enter a direct link!", "bg-orange-600");

    btn.disabled = true;
    btn.innerText = "TRANSFERRING...";

    try {
        const res = await puter.net.fetch(`https://api.abyss.to/v1/remote/url?key=${ABYSS_API}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                url: url,
                folderId: currentFolderId || "" 
            })
        });
        const data = await res.json();
        if (data.id || data.slug) {
            showToast("üöÄ Transfer Started!", "bg-green-600");
            urlInput.value = "";
        } else {
            showToast("Transfer Rejected", "bg-red-600");
        }
    } catch (e) { showToast("Connection Error", "bg-red-600"); }
    btn.disabled = false;
    btn.innerText = "Start Remote Transfer";
}

// --- TMDB Logic ---
async function searchTMDB() {
    const query = document.getElementById('apiSearch').value.trim();
    const type = document.getElementById('contentType').value === 'series' ? 'tv' : 'movie';
    const resDiv = document.getElementById('tmdbResults');
    if (query.length < 2) return;
    try {
        const res = await fetch(`https://api.themoviedb.org/3/search/${type}?api_key=${TMDB_API}&query=${encodeURIComponent(query)}`);
        const data = await res.json();
        resDiv.innerHTML = '';
        data.results.slice(0, 10).forEach(item => {
            const card = document.createElement('div');
            card.className = 'flex-shrink-0 w-24 text-center space-y-2 cursor-pointer group';
            const poster = item.poster_path ? IMG_BASE + item.poster_path : 'https://via.placeholder.com/200x300';
            const year = (item.release_date || item.first_air_date || 'N/A').split('-')[0];
            card.onclick = () => selectMovie(item, poster, year);
            card.innerHTML = `
                <img src="${poster}" class="w-full h-36 object-cover rounded-xl border border-slate-800 group-hover:border-blue-500 transition-all shadow-lg">
                <p class="text-[9px] font-bold truncate uppercase tracking-tighter">${item.title || item.name}</p>
            `;
            resDiv.appendChild(card);
        });
    } catch (e) {}
}

async function selectMovie(item, poster, year) {
    selectedMovie = item;
    const title = item.title || item.name;
    document.getElementById('mName').value = title;
    document.getElementById('mImg').value = poster;
    document.getElementById('mYear').value = year;
    document.getElementById('mTmdb').value = item.id;
    document.getElementById('mId').value = title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
    if (document.getElementById('contentType').value === 'series') {
        const res = await fetch(`https://api.themoviedb.org/3/tv/${item.id}?api_key=${TMDB_API}`);
        const data = await res.json();
        currentSeasons = data.seasons;
        const picker = document.getElementById('seasonPicker');
        picker.innerHTML = '<option value="">-- Choose Season --</option>';
        currentSeasons.forEach(s => {
            if (s.season_number === 0) return;
            picker.innerHTML += `<option value="${s.season_number}">${s.name} (${s.episode_count} Eps)</option>`;
        });
        document.getElementById('seasonWrapper').classList.remove('hidden');
    }
    updateOutputs();
}

function applySeason(num) {
    if(!num) return;
    const s = currentSeasons.find(i => i.season_number == num);
    document.getElementById('mName').value = `${selectedMovie.name} - Season ${num}`;
    document.getElementById('mId').value = `${selectedMovie.name.toLowerCase().replace(/[^a-z0-9]/g, '-')}-s${num}`;
    if(s.poster_path) document.getElementById('mImg').value = IMG_BASE + s.poster_path;
    updateOutputs();
}

function updateOutputs() {
    const type = document.getElementById('contentType').value;
    const name = document.getElementById('mName').value;
    const id = document.getElementById('mId').value;
    const img = document.getElementById('mImg').value;
    const year = document.getElementById('mYear').value;
    const tmdb = document.getElementById('mTmdb').value;
    let movieObj = { title: name, img: img, year: year, tmdb: tmdb, type: type };
    if (type === 'series') movieObj.episodes = document.getElementById('mEpisodes').value.split('\n').filter(l => l.trim() !== "");
    else movieObj.src = document.getElementById('mSrc').value;
    document.getElementById('outJS').value = `"${id}": ${JSON.stringify(movieObj, null, 2)},`;
    document.getElementById('outHTML').value = `<a href="newplayer/player?id=${id}&tmdb=${tmdb}" class="movie-link" data-id="${tmdb}">
    <div class="movie-card">
        <div class="movie-poster-container"><img src="${img}" class="movie-poster"></div>
        <div class="movie-info">
            <h3>${name}</h3>
            <p>${year} | ${type === 'movie' ? 'Movie' : 'Web Series'}</p>
        </div>
    </div>
</a>`;
}

// --- TELEGRAM ONLY LOGIC ---
async function triggerTelegram() {
    if (!selectedMovie) return showToast("Select content from TMDB first!", "bg-orange-600");
    
    const btn = document.getElementById('telegramBtn');
    btn.disabled = true;
    btn.innerText = "SENDING...";

    const name = document.getElementById('mName').value;
    const img = document.getElementById('mImg').value;
    const id = document.getElementById('mId').value;
    const msg = `üé¨ *NEW ON CINEVIEW* \n\nüçø *${name}*\n\nüîó [WATCH NOW](https://prigames.netlify.app/movies/newplayer/player?id=${id})`;

    try {
        const res = await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendPhoto`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: TG_CHAT, photo: img, caption: msg, parse_mode: 'Markdown' })
        });
        
        if (res.ok) showToast("Telegram Notification Sent!", "bg-green-600");
        else showToast("Telegram API Error", "bg-red-600");
    } catch (e) { showToast("Telegram Failed", "bg-red-600"); }
    
    btn.disabled = false;
    btn.innerText = "üì¢ SEND TO TELEGRAM";
}
</script>
</body>
</html>

