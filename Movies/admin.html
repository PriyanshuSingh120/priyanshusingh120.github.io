<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineView Admin Panel</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; padding: 20px; }
        .container { max-width: 800px; margin: auto; display: flex; flex-direction: column; gap: 20px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: none; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .tmdb-card { background: #333; padding: 5px; cursor: pointer; text-align: center; border-radius: 5px; transition: 0.3s; }
        .tmdb-card:hover { background: #444; transform: scale(1.05); }
        .tmdb-card img { width: 100%; border-radius: 5px; }
        .tmdb-card p { font-size: 12px; margin: 5px 0; height: 30px; overflow: hidden; }
        .admin-section { background: #222; padding: 20px; border-radius: 10px; border: 1px solid #444; }
        .btn-send { background: #0088cc; color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-send:hover { background: #00aaff; }
        label { font-weight: bold; font-size: 14px; color: #aaa; }
    </style>
</head>
<body>

<div class="container">
    <h2>CineView Admin Control</h2>

    <div class="admin-section">
        <label>Search TMDB Movie</label>
        <input type="text" id="apiSearch" oninput="searchTMDB()" placeholder="Type movie name...">
        <div id="results" class="results-grid"></div>
    </div>

    <div class="admin-section">
        <label>Movie Title</label>
        <input type="text" id="mName" oninput="updateOutputs()">
        
        <label>Custom ID (Editable - This will be in the URL)</label>
        <input type="text" id="mId" oninput="updateOutputs()">
        
        <label>Video Source Link</label>
        <input type="text" id="mSrc" placeholder="Paste video URL here" oninput="updateOutputs()">
        
        <label>Poster Image URL</label>
        <input type="text" id="mImg" oninput="updateOutputs()">

        <input type="hidden" id="mTmdb">
        <input type="hidden" id="mYear">

        <button class="btn-send" onclick="triggerTelegram()">üöÄ Send to Telegram Channel</button>
    </div>

    <div class="admin-section">
        <label>JS Config Object</label>
        <textarea id="outJS" rows="2" readonly onclick="this.select()"></textarea>
        
        <label>HTML List Item</label>
        <textarea id="outHTML" rows="3" readonly onclick="this.select()"></textarea>
    </div>
</div>

<script>
const API_KEY = 'dc691868b09daaabe9acc238ed898cf7';
const IMG_PATH = 'https://image.tmdb.org/t/p/w500';

// --- TELEGRAM CONFIG ---
const TELEGRAM_TOKEN = '7287243554:AAHa43wD_V2roGLep1aQgKHn0vqXHYlFp-M';
const TELEGRAM_CHAT_ID = '-1003605866054';

// Store the selected movie data globally for the telegram function
let selectedMovieData = null;

async function searchTMDB() {
    const query = document.getElementById('apiSearch').value;
    const resultsDiv = document.getElementById('results');
    if (query.length < 2) { resultsDiv.innerHTML = ''; return; }

    try {
        const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${API_KEY}&query=${encodeURIComponent(query)}`);
        const data = await res.json();
        
        resultsDiv.innerHTML = '';
        data.results.slice(0, 8).forEach(movie => {
            const poster = movie.poster_path ? IMG_PATH + movie.poster_path : 'https://via.placeholder.com/200x300';
            const year = movie.release_date ? movie.release_date.split('-')[0] : 'N/A';
            
            const div = document.createElement('div');
            div.className = 'tmdb-card';
            div.innerHTML = `<img src="${poster}"><p>${movie.title}</p>`;
            
            div.onclick = () => selectMovie(movie, poster, year);
            resultsDiv.appendChild(div);
        });
    } catch (e) { console.error("Search failed"); }
}

function selectMovie(movie, poster, year) {
    selectedMovieData = movie; // Save reference
    document.getElementById('mName').value = movie.title;
    
    // Auto-generate ID but keep it editable
    const generatedId = movie.title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
    document.getElementById('mId').value = generatedId;
    
    document.getElementById('mTmdb').value = movie.id;
    document.getElementById('mImg').value = poster;
    document.getElementById('mYear').value = `${year} | Bollywood | HD`;
    
    updateOutputs();
    // Scroll to the edit section
    document.getElementById('mName').scrollIntoView({ behavior: 'smooth' });
}

function updateOutputs() {
    const name = document.getElementById('mName').value;
    const id = document.getElementById('mId').value;
    const src = document.getElementById('mSrc').value || 'LINK_HERE';
    const img = document.getElementById('mImg').value;
    const tmdb = document.getElementById('mTmdb').value;
    const yearVal = document.getElementById('mYear').value;
    const yearOnly = yearVal.split(' ')[0];

    // JS Output
    document.getElementById('outJS').value = `"${id}": { "title": "${name}", "src": "${src}", "year": "${yearOnly}", "img": "${img}" },`;

    // HTML Output - Updated to newplayer/index
    document.getElementById('outHTML').value = `<a href="newplayer/index.html?id=${id}&tmdb=${tmdb}" class="movie-link" data-id="${tmdb}">
    <div class="movie-card">
        <div class="movie-poster-container"><img src="${img}" class="movie-poster" loading="lazy"></div>
        <div class="movie-info"><h3>${name}</h3><p>${yearVal}</p></div>
    </div>
</a>`;
}

async function triggerTelegram() {
    if (!selectedMovieData) {
        alert("Please select a movie first!");
        return;
    }
    
    const btn = document.querySelector('.btn-send');
    btn.innerText = "Sending...";
    btn.disabled = true;

    await sendToTelegram(selectedMovieData);
    
    btn.innerText = "üöÄ Send to Telegram Channel";
    btn.disabled = false;
    alert("Sent Successfully!");
}

async function sendToTelegram(movie) {
    const rating = movie.vote_average ? movie.vote_average.toFixed(1) : "N/A";
    const poster = document.getElementById('mImg').value;
    const movieId = document.getElementById('mId').value; // Get the EDITABLE ID
    const year = document.getElementById('mYear').value.split(' ')[0];
    const name = document.getElementById('mName').value;

    const genreMap = { 28: "#Action", 12: "#Adventure", 16: "#Animation", 35: "#Comedy", 80: "#Crime", 18: "#Drama", 14: "#Fantasy", 27: "#Horror", 878: "#SciFi", 53: "#Thriller" };
    let hashtags = movie.genre_ids ? movie.genre_ids.map(id => genreMap[id]).filter(h => h).join(" ") : "";
    if (movie.original_language === 'hi') hashtags += " #Bollywood";

    const message = `üé¨ *New Upload on CineView!* \n\n` +
                    `üçø *Title:* ${name}\n` +
                    `‚≠ê *IMDb:* ${rating}/10\n` +
                    `üìÖ *Year:* ${year}\n\n` +
                    `üìù *Story:* ${movie.overview ? movie.overview.substring(0, 120) : "Enjoy the stream!"}...\n\n` +
                    `üîó [Watch Now](https://prigames.netlify.app/movies/newplayer/index?id=${movieId})\n\n` +
                    `${hashtags} #Prigames`;

    try {
        await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendPhoto`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                photo: poster,
                caption: message,
                parse_mode: 'Markdown'
            })
        });
    } catch (e) {
        console.error("Telegram Error:", e);
        alert("Failed to send to Telegram. Check console.");
    }
}
</script>

</body>
</html>
