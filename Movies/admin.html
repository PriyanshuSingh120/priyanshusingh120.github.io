<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CineView Pro Admin - TMDB Search</title>
    <style>
        :root { --primary: #e50914; --bg: #0a0a0a; --card: #161616; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #fff; padding: 20px; }
        .container { max-width: 1000px; margin: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        
        /* Search Section */
        .search-area { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #333; }
        .search-results { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .tmdb-card { background: #000; border-radius: 8px; cursor: pointer; transition: 0.3s; border: 2px solid transparent; overflow: hidden; }
        .tmdb-card:hover { border-color: var(--primary); transform: scale(0.98); }
        .tmdb-card img { width: 100%; display: block; }
        .tmdb-card p { font-size: 11px; padding: 5px; margin: 0; text-align: center; }

        /* Form Section */
        .form-area { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #333; position: sticky; top: 20px; }
        label { color: var(--primary); font-weight: bold; font-size: 13px; display: block; margin-top: 10px; }
        input { width: 100%; padding: 10px; background: #222; border: 1px solid #444; border-radius: 5px; color: #fff; margin-bottom: 5px; }
        textarea { width: 100%; height: 80px; background: #000; color: #0f0; border-radius: 5px; padding: 10px; font-family: monospace; font-size: 12px; border: 1px solid #333; margin-top: 5px; }
        h2 { margin-top: 0; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        .btn-copy { background: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; float: right; font-size: 11px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="search-area">
            <h2>1. Find Movie</h2>
            <input type="text" id="apiSearch" oninput="searchTMDB()" placeholder="Search movies...">
            <div id="results" class="search-results">
                <p style="color: #666;">Results will appear here...</p>
            </div>
        </div>

        <div class="form-area">
            <h2>2. Finalize Code</h2>
            
            <label>Abyss/Short.icu Link (Add manually)</label>
            <input type="text" id="mSrc" placeholder="https://short.icu/xxxxxx" oninput="updateOutputs()">

            <label>Movie Title</label>
            <input type="text" id="mName" readonly>

            <label>Auto-ID (Matching Key)</label>
            <input type="text" id="mId" readonly>

            <label>TMDB ID</label>
            <input type="text" id="mTmdb" readonly>

            <label>Poster Image</label>
            <input type="text" id="mImg" readonly>

            <label>Year / Metadata</label>
            <input type="text" id="mYear" readonly>

            <div style="margin-top: 20px;">
                <label>Add to <u>player.js</u></label>
                <textarea id="outJS"></textarea>
                
                <label>Add to <u>index.html</u></label>
                <textarea id="outHTML"></textarea>
            </div>
            <button class="btn" style="background: #0088cc; margin-top: 10px;" onclick="sendToTelegram()">
           üì§ Post to Telegram Channel
           </button>
          <p id="telStatus" style="font-size: 12px; margin-top: 5px;"></p>
        </div>
    </div>

    <script>
const API_KEY = 'dc691868b09daaabe9acc238ed898cf7';
const IMG_PATH = 'https://image.tmdb.org/t/p/w500';

// --- TELEGRAM CONFIG ---
const TELEGRAM_TOKEN = '7287243554:AAHa43wD_V2roGLep1aQgKHn0vqXHYlFp-M';
const TELEGRAM_CHAT_ID = '-1003605866054';

// 1. Added a timer variable for debouncing
let debounceTimer;

async function searchTMDB() {
    const query = document.getElementById('apiSearch').value.trim();
    const resultsDiv = document.getElementById('results');

    // Clear the timer every time the user types a new character
    clearTimeout(debounceTimer);

    if (query.length < 2) {
        resultsDiv.innerHTML = '';
        return;
    }

    // 2. Wrap the fetch in a setTimeout (Debounce of 500ms)
    debounceTimer = setTimeout(async () => {
        try {
            const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${API_KEY}&query=${encodeURIComponent(query)}`);
            
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            
            const data = await res.json();
            
            resultsDiv.innerHTML = '';
            if (!data.results || data.results.length === 0) {
                resultsDiv.innerHTML = '<p style="color:white; padding:10px;">No movies found.</p>';
                return;
            }

            data.results.slice(0, 10).forEach(movie => {
                const poster = movie.poster_path ? IMG_PATH + movie.poster_path : 'https://via.placeholder.com/200x300';
                const year = movie.release_date ? movie.release_date.split('-')[0] : 'N/A';
                
                const div = document.createElement('div');
                div.className = 'tmdb-card';
                div.innerHTML = `<img src="${poster}"><p>${movie.title} (${year})</p>`;
                
                div.onclick = () => {
                    selectMovie(movie, poster, year);
                    sendToTelegram(movie, poster, year); 
                };
                resultsDiv.appendChild(div);
            });
        } catch (e) { 
            console.error("Search failed:", e);
            // Help identify if an adblocker is the cause
            if (e.message.includes("Failed to fetch")) {
                resultsDiv.innerHTML = '<p style="color:red; padding:10px;">Network Blocked (Try disabling AdBlock)</p>';
            }
        }
    }, 500); // 500ms delay
}

function selectMovie(movie, poster, year) {
    document.getElementById('mName').value = movie.title;
    // Improved ID generation to be cleaner
    const cleanId = movie.title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
    document.getElementById('mId').value = cleanId;
    document.getElementById('mTmdb').value = movie.id;
    document.getElementById('mImg').value = poster;
    document.getElementById('mYear').value = `${year} | Bollywood | HD`;
    updateOutputs();
}

function updateOutputs() {
    const name = document.getElementById('mName').value;
    const id = document.getElementById('mId').value;
    const src = document.getElementById('mSrc').value || 'LINK_HERE';
    const img = document.getElementById('mImg').value;
    const tmdb = document.getElementById('mTmdb').value;
    const year = document.getElementById('mYear').value;

    document.getElementById('outJS').value = `"${id}": { "title": "${name}", "src": "${src}", "year": "${year.split(' ')[0]}", "img": "${img}" },`;

    document.getElementById('outHTML').value = `<a href="newplayer/player.html?id=${id}&tmdb=${tmdb}" class="movie-link" data-id="${tmdb}">
    <div class="movie-card">
        <div class="movie-poster-container"><img src="${img}" class="movie-poster" loading="lazy"></div>
        <div class="movie-info"><h3>${name}</h3><p>${year}</p></div>
    </div>
</a>`;
}

async function sendToTelegram(movie, poster, year) {
    const rating = movie.vote_average ? movie.vote_average.toFixed(1) : "N/A";
    const movieId = document.getElementById('mId').value; // Use the cleaned ID from the input
    
    const genreMap = { 28: "#Action", 12: "#Adventure", 16: "#Animation", 35: "#Comedy", 80: "#Crime", 18: "#Drama", 14: "#Fantasy", 27: "#Horror", 878: "#SciFi", 53: "#Thriller" };
    let hashtags = movie.genre_ids ? movie.genre_ids.map(id => genreMap[id]).filter(h => h).join(" ") : "";
    if (movie.original_language === 'hi') hashtags += " #Bollywood";

    const message = `üé¨ *New Upload on CineView!* \n\n` +
                    `üçø *Title:* ${movie.title}\n` +
                    `‚≠ê *IMDb:* ${rating}/10\n` +
                    `üìÖ *Year:* ${year}\n\n` +
                    `üìù *Story:* ${movie.overview ? movie.overview.substring(0, 120) : "Enjoy the stream!"}...\n\n` +
                    `üîó [Watch Now](https://prigames.netlify.app/movies/newplayer/player?id=${movieId}&tmdb=${movie.id})\n\n` +
                    `${hashtags} #Prigames`;

    try {
        await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendPhoto`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                photo: poster,
                caption: message,
                parse_mode: 'Markdown'
            })
        });
    } catch (e) {
        console.error("Telegram Send Failed:", e);
    }
}
</script>
</body>

</html>





